# Week 3 - 自动控制原理智能问答系统的设计与优化

## 一、 实验目的

1. **构建垂直领域 RAG 系统**：基于 `Qwen2.5-1.5B` 模型与 `FAISS` 向量数据库，搭建面向《自动控制原理》课程的智能问答系统。
2. **实现精准知识溯源**：解决电子版教材（PDF）物理页码与逻辑页码不一致的问题，实现精确到“书本页码”的引用来源显示。
3. **优化前端交互体验**：基于 `Streamlit` 开发可视化界面，重点解决数学公式（LaTeX）在 Markdown 中的渲染与显示问题。
4. **量化评估与迭代**：设计评估脚本，通过 Recall（召回率）和 F1 Score 等指标，量化对比 RAG 系统与原生模型的性能差异。

## 二、 实验环境

- **操作系统**：Windows / Linux
- **编程语言**：Python 3.10+
- **核心模型**：
  - LLM: `Qwen/Qwen2.5-1.5B-Instruct`
  - Embedding: `BAAI/bge-small-zh-v1.5`
- **关键库**：`LangChain`, `FAISS`, `Streamlit`, `PyMuPDF (fitz)`, `RapidOCR`
- **硬件支持**：CUDA GPU 加速 (或 CPU 推理)

## 三、 实验内容与关键步骤

### 1. 数据处理与精准溯源 (Data Pipeline)

针对原始 PDF 教材（`textbook.pdf`）存在的扫描件识别难、页码错位问题，编写了 `step02_build_db.py` 进行处理：

- **混合读取机制**：集成 `PyMuPDF` 提取文本与 `RapidOCR` 识别图片页，确保无遗漏。
- **页码偏移修正算法**：
  - **问题**：PDF 阅读器显示的第 11 页对应书本正文第 1 页，直接读取会导致引用错误。
  - **解决方案**：引入 `PAGE_OFFSET` 参数（设为 10）。
  - **逻辑**：`Display_Page = Physical_PDF_Page - PAGE_OFFSET`。
- **多源数据融合**：支持同时挂载教材与习题集，建立统一的 FAISS 向量索引。

### 2. 交互式前端开发 (Web Demo)

基于 `Streamlit` 构建了 `step06_rag_web_demo.py`，主要实现了：

- **LaTeX 渲染引擎**：编写正则表达式（Regex）清洗管道，自动将非标准的数学符号转换为 MathJax 可识别的 LaTeX 格式（如处理矩阵 `\begin{array}` 环境），解决了公式乱码问题。
- **阈值拦截机制**：设置相似度阈值（Threshold = 0.45），对用户输入的无关问题（如闲聊、其他学科问题）进行有效拦截，防止模型幻觉。

### 3. 系统量化评估 (Evaluation)

编写 `step07_evaluation.py`，基于 `eval_dataset.json`（含 Ground Truth）进行自动化测试：

- **评估指标**：
  - **Recall (召回率)**：衡量系统是否检索到了正确知识点。
  - **F1 Score**：综合衡量回答的准确度与完整性。
- **优化策略**：引入分词模糊匹配与停用词过滤，解决了“关键词完全匹配”导致的分数虚低问题。

## 四、 实验结果展示

### 1. 知识库构建结果

系统能够将引用来源准确指向教材页码：

![content](images\content.png)

> ![content0](images\content0.png)

### 2. Web 端问答效果

系统能够使用Latex格式清晰显示公式：

> ![formula](images\formula.png)

### 3. 量化评估报告

经过优化后的评估脚本运行结果如下：

| **评估指标**        | **Baseline (纯模型)** | **Optimized (RAG系统)** | **提升率**  |
| ------------------- | --------------------- | ----------------------- | ----------- |
| **Recall (召回率)** | 0.4821                | **0.5897**              | **+22.31%** |
| **F1 Score**        | 0.1976                | **0.2946**              | **+49.13%** |
| **幻觉拦截率**      | 0%                    | **100%**                | /           |

**数据分析**：

- 引入 RAG 后，系统的 F1 分数提升了近 **50%**，证明外部知识库显著修正了小参数模型的专业知识缺陷。
- 实现了 **100% 的安全拦截**，有效过滤了“训练DeepSeek”、“地球月亮距离”等非本领域问题。

## 五、 问题与解决方案 (Challenges & Solutions)

1. **问题：引用页码与书本不对应**
   - **现象**：模型引用的页码往往是 PDF 文件的物理页数，比书本实际页码多出封面和目录的页数。
   - **解决**：在元数据提取阶段增加 `Offset` 减法逻辑，手动校准偏移量，实现了“所见即所得”的引用。
2. **问题：数学公式显示乱码**
   - **现象**：模型生成的 LaTeX 代码（如矩阵、积分）在网页上直接显示为纯文本代码块。
   - **解决**：开发了专门的 `format_latex` 清洗函数，智能封装 `$$...$$` 标记，并规范化矩阵环境语法。
3. **问题：评估分数偏低**
   - **现象**：初步评估 F1 仅 0.19，主要因为传统词形匹配对同义词（如“震荡”与“振荡”）判定过严。
   - **解决**：优化评估算法，引入模糊匹配策略并扩充停用词表，使评分更符合人类主观判断。

## 六、 实验总结

本次实验成功完成了一个全栈式的垂直领域 RAG 系统开发。ControlExpert 2.0 不仅实现了从数据清洗到前端展示的完整闭环，更在**工程细节**（如页码修正、公式渲染）和**安全性**（防幻觉拦截）上达到了较高的完成度。评估数据表明，该系统相比纯大模型在专业准确度上有显著提升，具备实际辅助教学的应用价值。